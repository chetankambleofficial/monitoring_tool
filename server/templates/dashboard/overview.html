{% extends "dashboard/base.html" %}

{% block title %}Overview - SentinelEdge Dashboard{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-8">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2">ğŸ›¡ï¸ Dashboard Overview</h1>
        <p class="text-gray-600 dark:text-gray-400 mt-1">Fleet-wide activity and agent status summary</p>
    </div>
    <div class="flex items-center gap-4">
        <span id="last-updated" class="text-sm text-gray-500 dark:text-gray-400">Last updated: Just now</span>
        <span class="refresh-indicator" id="refresh-indicator">
            <div class="w-5 h-5 border-2 border-primary-200 border-t-primary-600 rounded-full animate-spin"></div>
        </span>
    </div>
</div>

<!-- Fleet Summary Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 hover:shadow-md transition-shadow">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-primary-100 dark:bg-primary-900 rounded-lg flex items-center justify-center text-2xl">ğŸ‘¥</div>
            <div>
                <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Total Agents</div>
                <p id="total-agents" class="text-2xl font-bold text-gray-900 dark:text-gray-100">-</p>
                <div class="text-xs text-gray-500 dark:text-gray-400">Registered fleet size</div>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 hover:shadow-md transition-shadow">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-success-100 dark:bg-success-900 rounded-lg flex items-center justify-center text-2xl">ğŸŸ¢</div>
            <div>
                <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Online Now</div>
                <p id="active-agents" class="text-2xl font-bold text-success-600 dark:text-success-400">-</p>
                <div class="text-xs text-gray-500 dark:text-gray-400">Active in last 5 mins</div>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 hover:shadow-md transition-shadow">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-red-100 dark:bg-red-900 rounded-lg flex items-center justify-center text-2xl">ğŸ”´</div>
            <div>
                <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Offline</div>
                <p id="offline-agents" class="text-2xl font-bold text-red-600 dark:text-red-400">-</p>
                <div class="text-xs text-gray-500 dark:text-gray-400">Agents currently disconnected</div>
            </div>
        </div>
    </div>
</div>


<!-- Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Agent Status</h3>
        </div>
        <div class="p-6">
            <div class="h-64 relative">
                <canvas id="agent-status-chart"></canvas>
            </div>
        </div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Fleet Screen Time Breakdown</h3>
        </div>
        <div class="p-6">
            <div class="h-64 relative">
                <canvas id="screentime-chart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Top Apps & Domains -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">ğŸ† Top App Today</div>
        <p id="top-app-name" class="text-xl font-bold text-primary-600 dark:text-primary-400 mb-2">-</p>
        <div id="top-app-duration" class="font-semibold text-gray-600 dark:text-gray-300 mb-2">-</div>
        <div class="text-xs text-gray-500 dark:text-gray-400">Fleet-wide usage</div>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
        <div class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">ğŸŒ Top Domain Today</div>
        <p id="top-domain-name" class="text-xl font-bold text-primary-600 dark:text-primary-400 mb-2">-</p>
        <div id="top-domain-duration" class="font-semibold text-gray-600 dark:text-gray-300 mb-2">-</div>
        <div class="text-xs text-gray-500 dark:text-gray-400">Fleet-wide usage</div>
    </div>
</div>

<!-- Top 5 Agents Widget -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">ğŸ† Top 5 Agents</h3>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Leaders by screen time category</p>
    </div>
    <div class="p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div>
                <h4 class="text-sm font-semibold text-warning-600 dark:text-warning-400 mb-4 flex items-center gap-2">â¸ï¸ Most Idle Time</h4>
                <ul id="top-idle-list" class="space-y-2">
                    <li class="text-gray-500 dark:text-gray-400">Loading...</li>
                </ul>
            </div>
            <div>
                <h4 class="text-sm font-semibold text-success-600 dark:text-success-400 mb-4 flex items-center gap-2">âœ… Most Active Time</h4>
                <ul id="top-active-list" class="space-y-2">
                    <li class="text-gray-500 dark:text-gray-400">Loading...</li>
                </ul>
            </div>
            <div>
                <h4 class="text-sm font-semibold text-red-600 dark:text-red-400 mb-4 flex items-center gap-2">ğŸ”’ Most Locked Time</h4>
                <ul id="top-locked-list" class="space-y-2">
                    <li class="text-gray-500 dark:text-gray-400">Loading...</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
{# All styles now in dashboard.css #}
{% endblock %}

{% block extra_js %}
<script>
    function getSelectedDate() {
        // Use global date selector from navbar
        const dateInput = document.getElementById('global-date-select');
        if (dateInput && dateInput.value) {
            return dateInput.value;
        }
        const params = new URLSearchParams(window.location.search);
        return params.get('date') || new Date().toISOString().split('T')[0];
    }

    // Initialize global date picker and attach listener
    document.addEventListener('DOMContentLoaded', () => {
        const dateInput = document.getElementById('global-date-select');
        if (dateInput) {
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = getSelectedDate();
            dateInput.max = today;
            // Attach change listener for this page
            dateInput.addEventListener('change', () => {
                loadOverview();
            });
        }
    });

    async function loadOverview() {
        document.getElementById('refresh-indicator').classList.add('active');

        const selectedDate = getSelectedDate();
        const data = await fetchJSON(`/dashboard/api/overview?date=${selectedDate}`);

        document.getElementById('refresh-indicator').classList.remove('active');

        if (!data) return;

        // Update metrics
        document.getElementById('total-agents').textContent = data.total_agents;
        document.getElementById('active-agents').textContent = data.active_agents;
        document.getElementById('offline-agents').textContent = data.offline_agents;


        // Update Highlights
        document.getElementById('top-app-name').textContent = data.top_app.name;
        document.getElementById('top-app-duration').textContent = formatTime(data.top_app.duration);

        document.getElementById('top-domain-name').textContent = data.top_domain.name;
        document.getElementById('top-domain-duration').textContent = formatTime(data.top_domain.duration);

        // Update Top 5 Agents
        renderTop5Agents(data);

        // Update Last Updated
        document.getElementById('last-updated').textContent = "Last updated: " + new Date().toLocaleTimeString();

        // -- Charts --
        renderCharts(data);
    }


    function renderCharts(data) {
        // 1. Agent Status Pie Chart
        const ctxStatus = document.getElementById('agent-status-chart');
        if (window.statusChart) window.statusChart.destroy();

        window.statusChart = new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
                labels: ['Online', 'Offline'],
                datasets: [{
                    data: [data.active_agents, data.offline_agents],
                    backgroundColor: ['#10b981', '#ef4444']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });

        // 2. Screen Time Breakdown Chart
        const ctxScreen = document.getElementById('screentime-chart');
        if (window.screenChart) window.screenChart.destroy();

        const awayTime = data.screen_time.away || 0;
        window.screenChart = new Chart(ctxScreen, {
            type: 'doughnut',
            data: {
                labels: ['Active', 'Idle', 'Locked', 'Away'],
                datasets: [{
                    data: [data.screen_time.active, data.screen_time.idle, data.screen_time.locked, awayTime],
                    backgroundColor: ['#38bdf8', '#fbbf24', '#64748b', '#334155']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => ctx.label + ': ' + formatTime(ctx.parsed)
                        }
                    }
                }
            }
        });
    }

    function renderTop5Agents(data) {
        // Render Top Idle Agents
        const idleList = document.getElementById('top-idle-list');
        if (data.top_idle_agents && data.top_idle_agents.length > 0) {
            idleList.innerHTML = data.top_idle_agents.map((agent, index) => `
                <li class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-600 last:border-b-0">
                    <span class="text-sm text-gray-900 dark:text-gray-100"><strong>${index + 1}.</strong> ${agent.hostname}</span>
                    <span class="font-mono text-sm text-warning-600 dark:text-warning-400">${formatTime(agent.idle_seconds)}</span>
                </li>
            `).join('');
        } else {
            idleList.innerHTML = '<li class="text-gray-500 dark:text-gray-400 text-sm">No data</li>';
        }

        // Render Top Active Agents
        const activeList = document.getElementById('top-active-list');
        if (data.top_active_agents && data.top_active_agents.length > 0) {
            activeList.innerHTML = data.top_active_agents.map((agent, index) => `
                <li class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-600 last:border-b-0">
                    <span class="text-sm text-gray-900 dark:text-gray-100"><strong>${index + 1}.</strong> ${agent.hostname}</span>
                    <span class="font-mono text-sm text-success-600 dark:text-success-400">${formatTime(agent.active_seconds)}</span>
                </li>
            `).join('');
        } else {
            activeList.innerHTML = '<li class="text-gray-500 dark:text-gray-400 text-sm">No data</li>';
        }

        // Render Top Locked Agents
        const lockedList = document.getElementById('top-locked-list');
        if (data.top_locked_agents && data.top_locked_agents.length > 0) {
            lockedList.innerHTML = data.top_locked_agents.map((agent, index) => `
                <li class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-600 last:border-b-0">
                    <span class="text-sm text-gray-900 dark:text-gray-100"><strong>${index + 1}.</strong> ${agent.hostname}</span>
                    <span class="font-mono text-sm text-red-600 dark:text-red-400">${formatTime(agent.locked_seconds)}</span>
                </li>
            `).join('');
        } else {
            lockedList.innerHTML = '<li class="text-gray-500 dark:text-gray-400 text-sm">No data</li>';
        }
    }

    // Initial Load
    document.addEventListener('DOMContentLoaded', () => {
        loadOverview();
    });

    // Refresh every 30s for more real-time data
    setInterval(() => {
        loadOverview();
    }, 30000);
</script>
{% endblock %}