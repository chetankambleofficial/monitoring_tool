{% extends "dashboard/base.html" %}

{% block title %}{{ agent.hostname }} - SentinelEdge Dashboard{% endblock %}

{% block content %}
<!-- HEADER: User-centric with activity badge -->
<div class="page-header fade-in">
    <div class="header-left">
        <a href="{{ url_for('dashboard.dashboard_home') }}" class="back-link">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M19 12H5m7 7l-7-7 7-7" />
            </svg>
            Back to Overview
        </a>
        <div class="flex items-center gap-4 mt-3">
            <h1 id="agent-title">üë§ Loading...</h1>
            <div id="status-badge-container"></div>
        </div>
        <p id="agent-subtitle" class="text-secondary font-medium mt-1">
            <span id="agent-device">üñ•Ô∏è {{ agent.hostname or agent.agent_id|string }}</span>
            <span class="text-tertiary"> ‚Ä¢ </span>
            <span id="agent-os">{{ agent.os }}</span>
        </p>
    </div>
    <div class="header-right flex items-center gap-3">
        <div class="activity-badge-container">
            <span class="activity-badge-label">Current Activity</span>
            <span id="current-activity" class="activity-badge">Loading...</span>
        </div>
        <a href="{{ url_for('dashboard.agent_report', agent_id=agent.agent_id) }}" class="btn btn-primary">
            üìä Report
        </a>
    </div>
</div>

<!-- LIVE STATUS BANNER -->
<div id="live-status-banner" class="live-status-banner fade-in" style="display:none;">
    <div class="live-indicator">
        <span class="pulse"></span>
        <span class="live-text">LIVE</span>
    </div>
    <div class="live-details">
        <span id="live-app-name" class="live-app"></span>
        <span id="live-window-title" class="live-window"></span>
    </div>
    <div class="live-duration">
        <span id="live-duration">--</span>
    </div>
</div>

<!-- TAB NAVIGATION -->
<div class="tabs-container fade-in">
    <div class="tabs-nav">
        <button class="tab-btn active" data-tab="overview">üìä Overview</button>
        <button class="tab-btn" data-tab="activity">üì± Activity</button>
        <button class="tab-btn" data-tab="web">üåê Web</button>
        <button class="tab-btn" data-tab="inventory">üì¶ Inventory</button>
    </div>
</div>

<!-- TAB: OVERVIEW -->
<div id="tab-overview" class="tab-content active">
    <!-- Agent Info Card -->
    <div class="card fade-in">
        <div class="card-body">
            <div class="agent-info-grid">
                <div class="info-item">
                    <div class="info-label">üÜî Agent ID</div>
                    <div class="info-value font-mono" style="display: flex; align-items: center; gap: 0.5rem;">
                        <code>{{ (agent.agent_id|string)[:12] }}...</code>
                        <button onclick="copyAgentId()" class="copy-btn" title="Copy full Agent ID">üìã</button>
                        <input type="hidden" id="agent-id-full" value="{{ agent.agent_id }}">
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">üíª OS Platform</div>
                    <div class="info-value">{{ agent.os }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">üìÖ Registered</div>
                    <div class="info-value" id="registered-at">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">üåÖ First Seen Today</div>
                    <div class="info-value" id="first-seen-today">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">üëÅÔ∏è Last Seen</div>
                    <div class="info-value" id="last-seen">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">‚ö° Current State</div>
                    <div class="info-value">
                        <span id="current-state" class="badge badge-success">Active</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats Bar -->
    <h3 class="section-title">‚ö° Quick Stats</h3>
    <div class="quick-stats-grid fade-in">
        <div class="stat-box">
            <div class="stat-icon">‚è±Ô∏è</div>
            <div class="stat-content">
                <div class="stat-value" id="quick-screen-time">--</div>
                <div class="stat-label">Screen Time Today</div>
            </div>
        </div>

        <div class="stat-box">
            <div class="stat-icon">üì±</div>
            <div class="stat-content">
                <div class="stat-value" id="quick-apps-count">--</div>
                <div class="stat-label">Apps Used</div>
            </div>
        </div>

        <div class="stat-box">
            <div class="stat-icon">üåê</div>
            <div class="stat-content">
                <div class="stat-value" id="quick-domains-count">--</div>
                <div class="stat-label">Domains Visited</div>
            </div>
        </div>

        <div class="stat-box">
            <div class="stat-icon">üîÑ</div>
            <div class="stat-content">
                <div class="stat-value" id="quick-sessions-count">--</div>
                <div class="stat-label">App Sessions</div>
            </div>
        </div>
    </div>

    <!-- Screen Time Metrics -->
    <h3 class="section-title">üìä Today's Screen Time</h3>
    <div class="metrics-grid fade-in">
        <div class="metric-card state-active">
            <div class="metric-icon">üéØ</div>
            <div class="metric-label">Active Time</div>
            <div class="metric-value" id="active-time">--</div>
            <div class="metric-sublabel" id="active-pct">--</div>
        </div>
        <div class="metric-card state-idle">
            <div class="metric-icon">üí§</div>
            <div class="metric-label">Idle Time</div>
            <div class="metric-value" id="idle-time">--</div>
            <div class="metric-sublabel" id="idle-pct">--</div>
        </div>
        <div class="metric-card state-locked">
            <div class="metric-icon">üîí</div>
            <div class="metric-label">Locked Time</div>
            <div class="metric-value" id="locked-time">--</div>
            <div class="metric-sublabel" id="locked-pct">--</div>
        </div>
        <div class="metric-card state-away">
            <div class="metric-icon">‚≠ï</div>
            <div class="metric-label">Away Time</div>
            <div class="metric-value" id="away-time">--</div>
            <div class="metric-sublabel" id="away-pct">--</div>
        </div>
        <div class="metric-card gradient">
            <div class="metric-icon">‚è±Ô∏è</div>
            <div class="metric-label">Total Productive</div>
            <div class="metric-value" id="total-time">--</div>
            <div class="metric-sublabel">Full day activity</div>
        </div>
    </div>

    <!-- 7-Day Chart -->
    <h3 class="section-title">üìà Screen Time (Last 7 Days)</h3>
    <div class="chart-card full-width">
        <div class="chart-container-lg" style="height: 300px; position: relative;">
            <canvas id="screentime-history-chart"></canvas>
        </div>
    </div>
</div>

<!-- TAB: ACTIVITY -->
<div id="tab-activity" class="tab-content" style="display:none;">
    <div class="grid-2-col">
        <!-- App Usage -->
        <div class="card">
            <div class="card-header">
                <h3>üì± Application Usage</h3>
                <span id="apps-count" class="badge badge-info">0 apps</span>
            </div>
            <div class="table-search">
                <input type="text" id="app-search" placeholder="Search apps..." class="search-input-sm">
            </div>
            <div id="app-ongoing-section" class="ongoing-section" style="display:none;">
                <div class="ongoing-header">üéØ Currently Using</div>
                <div class="ongoing-row">
                    <span id="ongoing-app-name" class="ongoing-name">--</span>
                    <span id="ongoing-app-duration" class="ongoing-duration">--</span>
                </div>
            </div>
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="data-table sticky-header" id="apps-table">
                    <thead>
                        <tr>
                            <th>Application</th>
                            <th class="text-right">Sessions</th>
                            <th class="text-right">Duration</th>
                            <th class="text-right">%</th>
                        </tr>
                    </thead>
                    <tbody id="apps-body">
                        <tr>
                            <td colspan="4" class="text-center">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Domain Usage -->
        <div class="card">
            <div class="card-header">
                <h3>üåê Domain Usage</h3>
                <span id="domains-count" class="badge badge-info">0 domains</span>
            </div>
            <div class="table-search">
                <input type="text" id="domain-search" placeholder="Search domains..." class="search-input-sm">
            </div>
            <div id="domain-ongoing-section" class="ongoing-section" style="display:none;">
                <div class="ongoing-header">üåç Currently Browsing</div>
                <div class="ongoing-row">
                    <span id="ongoing-domain-name" class="ongoing-name">--</span>
                    <span id="ongoing-domain-duration" class="ongoing-duration">--</span>
                </div>
            </div>
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="data-table sticky-header" id="domains-table">
                    <thead>
                        <tr>
                            <th>Domain</th>
                            <th class="text-right">Sessions</th>
                            <th class="text-right">Duration</th>
                            <th class="text-right">%</th>
                        </tr>
                    </thead>
                    <tbody id="domains-body">
                        <tr>
                            <td colspan="4" class="text-center">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- TAB: WEB -->
<div id="tab-web" class="tab-content" style="display:none;">
    <div class="card">
        <div class="card-header">
            <h3>üïê Browser History (Today)</h3>
            <span id="visits-count" class="badge badge-secondary">0 visits</span>
        </div>
        <div class="table-search">
            <input type="text" id="visits-search" placeholder="Search sites..." class="search-input-sm">
        </div>
        <div class="sites-list" id="visits-list" style="max-height: 600px; overflow-y: auto;">
            <div class="text-center text-muted p-4">Loading...</div>
        </div>
    </div>
</div>

<!-- TAB: INVENTORY -->
<div id="tab-inventory" class="tab-content" style="display:none;">
    <div class="card">
        <div class="card-header">
            <h3>üì¶ Installed Applications</h3>
            <div>
                <span id="inventory-count" class="badge badge-info">0 apps</span>
                <button onclick="exportTableToCSV('inventory-table', 'inventory.csv')"
                    class="btn btn-sm btn-secondary ml-3">Export CSV</button>
            </div>
        </div>
        <div class="table-search">
            <input type="text" id="inventory-search" placeholder="Search applications..." class="search-input-sm">
        </div>
        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
            <table class="data-table sticky-header" id="inventory-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Version</th>
                        <th>Publisher</th>
                        <th>Install Location</th>
                        <th>Install Date</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody id="inventory-body">
                    <tr>
                        <td colspan="6" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    /* Tab Navigation */
    .tabs-container {
        margin: 0 0 1.5rem 0;
    }

    .tabs-nav {
        display: flex;
        background: var(--card-bg);
        border-radius: 10px;
        padding: 4px;
        border: 1px solid var(--border);
    }

    .tab-btn {
        flex: 1;
        padding: 0.6rem 1rem;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 0.85rem;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .tab-btn:hover {
        color: var(--text);
        background: var(--bg-secondary);
    }

    .tab-btn.active {
        color: white;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }

    .tab-content {
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    /* Activity Badge */
    .activity-badge-container {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.25rem;
        margin-right: 1rem;
    }

    .activity-badge-label {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-tertiary);
    }

    .activity-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        border-radius: 2rem;
        font-weight: 600;
        font-size: 0.85rem;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Live Status Banner */
    .live-status-banner {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
        border-radius: 12px;
        padding: 1rem 1.5rem;
        margin: 1rem 0 1.5rem 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1.5rem;
        color: white;
        box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
    }

    .live-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .pulse {
        width: 10px;
        height: 10px;
        background: #22c55e;
        border-radius: 50%;
        animation: pulse-glow 1.5s ease-in-out infinite;
        box-shadow: 0 0 8px #22c55e;
    }

    @keyframes pulse-glow {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
            transform: scale(1.3);
        }
    }

    .live-text {
        font-weight: 700;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 1.5px;
    }

    .live-details {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
    }

    .live-app {
        font-weight: 700;
        font-size: 1rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .live-window {
        font-size: 0.8rem;
        opacity: 0.85;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .live-duration {
        font-size: 1.1rem;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
        background: rgba(255, 255, 255, 0.2);
        padding: 0.4rem 0.8rem;
        border-radius: 8px;
    }

    /* Agent Info Grid */
    .agent-info-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }

    @media (max-width: 768px) {
        .agent-info-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 480px) {
        .agent-info-grid {
            grid-template-columns: 1fr;
        }
    }

    .info-item {
        padding: 0.75rem;
        background: var(--bg-secondary);
        border-radius: 0.5rem;
    }

    .info-label {
        font-size: 0.8rem;
        color: var(--text-tertiary);
        margin-bottom: 0.25rem;
    }

    .info-value {
        font-weight: 600;
        color: var(--text);
    }

    /* Table Search */
    .table-search {
        padding: 0.5rem 1rem;
        background: var(--card-bg);
    }

    .search-input-sm {
        width: 100%;
        padding: 0.5rem 0.875rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.85rem;
        background: var(--bg-secondary);
        color: var(--text);
        transition: all 0.2s ease;
    }

    .search-input-sm:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        background: var(--card-bg);
    }

    .search-input-sm::placeholder {
        color: var(--text-tertiary);
    }

    /* Sticky Headers */
    .sticky-header thead {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .sticky-header thead th {
        background: var(--card-bg);
        border-bottom: 2px solid var(--border);
    }

    /* Usage Progress Bars - Fixed Alignment */
    .usage-bar-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: flex-end;
        min-width: 120px;
    }

    .usage-bar-container span {
        min-width: 40px;
        text-align: right;
        font-variant-numeric: tabular-nums;
    }

    .usage-bar {
        flex: 0 0 60px;
        height: 6px;
        background: var(--border);
        border-radius: 3px;
        overflow: hidden;
    }

    .usage-bar-fill {
        height: 100%;
        border-radius: 3px;
    }

    .usage-bar-fill.high {
        background: linear-gradient(90deg, #10b981, #34d399);
    }

    .usage-bar-fill.medium {
        background: linear-gradient(90deg, #f59e0b, #fbbf24);
    }

    .usage-bar-fill.low {
        background: linear-gradient(90deg, #6b7280, #9ca3af);
    }

    /* Ongoing Section */
    .ongoing-section {
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border);
    }

    .ongoing-header {
        font-size: 0.75rem;
        font-weight: 600;
        color: #059669;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .ongoing-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .ongoing-name {
        font-weight: 600;
        font-size: 0.95rem;
    }

    .ongoing-duration {
        font-family: monospace;
        font-weight: 600;
        color: #10b981;
    }

    /* Site Items */
    .site-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .site-item:hover {
        background: var(--bg-secondary);
    }

    .site-item .time {
        font-size: 0.75rem;
        color: var(--text-tertiary);
        min-width: 80px;
        font-family: monospace;
    }

    .site-item .domain {
        font-weight: 500;
        flex: 1;
    }

    /* Section Title */
    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text);
        margin: 1.5rem 0 1rem 0;
    }

    /* Grid 2 Column */
    .grid-2-col {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
    }

    @media (max-width: 992px) {
        .grid-2-col {
            grid-template-columns: 1fr;
        }
    }

    /* ================================================================
       INVENTORY TABLE - ALL 6 COLUMNS, NO HORIZONTAL SCROLL
       Text wrapping enabled, compact layout
       ================================================================ */

    /* Remove horizontal scroll from table container */
    #tab-inventory .table-responsive {
        overflow-x: hidden !important;
    }

    #inventory-table {
        table-layout: fixed;
        width: 100%;
        border-collapse: collapse;
    }

    /* Column widths - ALL 6 columns always visible */
    #inventory-table th:nth-child(1),
    #inventory-table td:nth-child(1) {
        width: 20%;
        /* Name */
    }

    #inventory-table th:nth-child(2),
    #inventory-table td:nth-child(2) {
        width: 8%;
        /* Version */
    }

    #inventory-table th:nth-child(3),
    #inventory-table td:nth-child(3) {
        width: 15%;
        /* Publisher */
    }

    #inventory-table th:nth-child(4),
    #inventory-table td:nth-child(4) {
        width: 32%;
        /* Install Location - largest for paths */
    }

    #inventory-table th:nth-child(5),
    #inventory-table td:nth-child(5) {
        width: 12%;
        /* Install Date */
    }

    #inventory-table th:nth-child(6),
    #inventory-table td:nth-child(6) {
        width: 13%;
        /* Source */
    }

    /* Base cell styling - FORCE text wrapping */
    #inventory-table td {
        white-space: normal !important;
        word-break: break-word;
        overflow-wrap: break-word;
        vertical-align: top;
        padding: 0.4rem 0.3rem;
        line-height: 1.3;
        font-size: 0.8rem;
    }

    /* Header cells - compact */
    #inventory-table th {
        padding: 0.4rem 0.3rem;
        font-size: 0.7rem;
        white-space: nowrap;
    }

    /* Name column - bold, break words */
    #inventory-table td:nth-child(1) {
        font-weight: 500;
        word-break: break-word;
    }

    /* Version column - monospace, BREAK ALL for long versions */
    #inventory-table td:nth-child(2) {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.7rem;
        word-break: break-all;
    }

    /* Publisher column - break words */
    #inventory-table td:nth-child(3) {
        font-size: 0.75rem;
        word-break: break-word;
    }

    /* Install Location - SMALLEST font, BREAK ALL for long paths */
    #inventory-table td:nth-child(4) {
        font-size: 0.65rem;
        color: var(--text-tertiary);
        font-family: 'JetBrains Mono', monospace;
        word-break: break-all;
        line-height: 1.2;
    }

    /* Install Date - nowrap if possible, break if needed */
    #inventory-table td:nth-child(5) {
        font-size: 0.75rem;
        white-space: normal;
    }

    /* Source badge column - center aligned */
    #inventory-table td:nth-child(6) {
        text-align: center;
        font-size: 0.7rem;
    }

    /* Smaller screens - just reduce font sizes, keep all columns */
    @media (max-width: 1400px) {
        #inventory-table td {
            font-size: 0.75rem;
            padding: 0.35rem 0.25rem;
        }

        #inventory-table td:nth-child(4) {
            font-size: 0.6rem;
        }
    }

    @media (max-width: 1024px) {
        #inventory-table td {
            font-size: 0.7rem;
            padding: 0.3rem 0.2rem;
        }

        #inventory-table th {
            font-size: 0.65rem;
        }

        #inventory-table td:nth-child(4) {
            font-size: 0.55rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    const AGENT_ID = "{{ agent.agent_id }}";
    let reportData = null;

    // Tab Navigation
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.dataset.tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById(`tab-${tabName}`).style.display = 'block';
        });
    });

    // Search Filtering
    function setupSearch(inputId, containerId, selector) {
        const input = document.getElementById(inputId);
        if (!input) return;
        input.addEventListener('input', () => {
            const term = input.value.toLowerCase();
            document.querySelectorAll(`#${containerId} ${selector}`).forEach(el => {
                el.style.display = el.textContent.toLowerCase().includes(term) ? '' : 'none';
            });
        });
    }
    document.addEventListener('DOMContentLoaded', () => {
        setupSearch('app-search', 'apps-body', 'tr');
        setupSearch('domain-search', 'domains-body', 'tr');
        setupSearch('inventory-search', 'inventory-body', 'tr');
        setupSearch('visits-search', 'visits-list', '.site-item');
    });

    // ================================================================
    // Timezone Helpers
    // ================================================================
    // IMPORTANT: Server has TWO types of timestamps:
    // 1. Server-side (last_seen, registered_at) - stored in UTC
    // 2. Agent-side (app_sessions, domain_visits) - stored in IST
    // ================================================================

    // For SERVER-SIDE timestamps (UTC) - last_seen, registered_at, created_at
    function formatDateTimeFromUTC(dateStr) {
        if (!dateStr) return 'N/A';
        let ts = dateStr;
        if (!ts.endsWith('Z') && !ts.includes('+')) ts += 'Z';  // Treat as UTC
        const date = new Date(ts);
        if (isNaN(date.getTime())) return 'N/A';
        return date.toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true });
    }

    function getRelativeTimeFromUTC(dateStr) {
        if (!dateStr) return 'N/A';
        let ts = dateStr;
        if (!ts.endsWith('Z') && !ts.includes('+')) ts += 'Z';  // Treat as UTC
        const date = new Date(ts);
        if (isNaN(date.getTime())) return 'N/A';
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);
        if (diff < 0) return 'Just now';  // Future timestamp
        if (diff < 60) return 'Just now';
        if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
        return `${Math.floor(diff / 86400)}d ago`;
    }

    // For AGENT-SIDE timestamps (already IST) - app_sessions, domain_visits
    function formatDateTimeIST(dateStr) {
        if (!dateStr) return 'N/A';
        // Parse as local time - already in IST
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return 'N/A';
        return date.toLocaleString('en-IN', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true });
    }

    function formatTimeIST(dateStr) {
        if (!dateStr) return 'N/A';
        // Parse as local time - already in IST
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return 'N/A';
        return date.toLocaleString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
    }

    // For Browser History - convert UTC to IST for display
    function formatBrowserHistoryTime(dateStr) {
        if (!dateStr) return 'N/A';
        // Server stores timestamps in UTC - treat as UTC if no timezone info
        let ts = dateStr;
        if (!ts.endsWith('Z') && !ts.includes('+')) {
            ts += 'Z';  // Append Z to treat as UTC
        }
        const date = new Date(ts);
        if (isNaN(date.getTime())) return 'N/A';
        // Convert to IST (Asia/Kolkata = UTC+5:30)
        return date.toLocaleString('en-IN', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true,
            timeZone: 'Asia/Kolkata'
        });
    }

    function getRelativeTimeIST(dateStr) {
        if (!dateStr) return 'N/A';
        // Parse as local time - already in IST
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return 'N/A';
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);
        if (diff < 0) return 'Just now';
        if (diff < 60) return 'Just now';
        if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
        return `${Math.floor(diff / 86400)}d ago`;
    }
    function formatTime(seconds) {
        if (!seconds || seconds < 0) return '0s';
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        if (h > 0) return `${h}h ${m}m`;
        if (m > 0) return `${m}m ${s}s`;
        return `${s}s`;
    }

    function formatTimeShort(seconds) {
        if (!seconds || seconds < 0) return '0s';
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        if (h > 0) return h + 'h';
        if (m > 0) return m + 'm';
        return s + 's';
    }

    function getSelectedDate() {
        const el = document.getElementById('global-date-select');
        return el ? el.value : new Date().toISOString().split('T')[0];
    }

    async function fetchJSON(url) {
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(res.statusText);
            return await res.json();
        } catch (e) {
            console.error('Fetch error:', e);
            return null;
        }
    }

    // Copy Agent ID to clipboard (with fallback for HTTP)
    function copyAgentId() {
        const agentId = document.getElementById('agent-id-full').value;

        // Try modern clipboard API first
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(agentId).then(() => {
                showToast('Agent ID copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Clipboard API failed:', err);
                fallbackCopy(agentId);
            });
        } else {
            // Fallback for HTTP (non-secure contexts)
            fallbackCopy(agentId);
        }
    }

    // Fallback copy using execCommand (works on HTTP)
    function fallbackCopy(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showToast('Agent ID copied to clipboard!', 'success');
            } else {
                showToast('Copy failed - please copy manually', 'error');
            }
        } catch (err) {
            console.error('Fallback copy failed:', err);
            showToast('Copy failed - please copy manually', 'error');
        }

        document.body.removeChild(textArea);
    }

    // Toast notification helper
    function showToast(message, type = 'success') {
        // Remove existing toast
        const existing = document.querySelector('.toast');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        toast.style.background = type === 'success' ? 'var(--success)' : 'var(--danger)';
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOutDown 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Main data loader
    async function loadFullReport() {
        const selectedDate = getSelectedDate();
        const data = await fetchJSON(`/dashboard/api/agent/${AGENT_ID}/full-report?date=${selectedDate}`);
        if (!data) return;
        reportData = data;

        // Update agent info
        if (data.agent) {
            if (data.agent.username) {
                document.getElementById('agent-title').textContent = `üë§ ${data.agent.username}`;
            }
            // registered_at and last_seen are server-side UTC timestamps
            document.getElementById('registered-at').textContent = data.agent.registered_at ? formatDateTimeFromUTC(data.agent.registered_at) : '-';
            // first_seen_today is agent-side IST timestamp
            document.getElementById('first-seen-today').textContent = data.agent.first_seen_today ? formatTimeIST(data.agent.first_seen_today) : 'No activity';

            // FIX: Use last_seen_today for historical views, last_seen for today
            if (data.agent.is_viewing_today && data.agent.last_seen) {
                // Viewing today - show relative time
                document.getElementById('last-seen').innerHTML = `${getRelativeTimeFromUTC(data.agent.last_seen)}<br><small class="text-muted">${formatDateTimeFromUTC(data.agent.last_seen)}</small>`;
            } else if (data.agent.last_seen_today) {
                // Viewing historical date - show absolute time for that day
                document.getElementById('last-seen').innerHTML = `${formatTimeIST(data.agent.last_seen_today)}<br><small class="text-muted">Last activity on selected date</small>`;
            } else {
                document.getElementById('last-seen').textContent = 'No activity';
            }

            // Show total tracked time if available
            if (data.agent.total_tracked_seconds > 0) {
                const trackedEl = document.getElementById('total-tracked-time');
                if (trackedEl) {
                    trackedEl.textContent = formatTime(data.agent.total_tracked_seconds);
                }
            }
        }

        // Live status banner
        if (data.live_status && data.live_status.current_app) {
            document.getElementById('live-status-banner').style.display = 'flex';
            document.getElementById('live-app-name').textContent = data.live_status.current_app;
            document.getElementById('live-window-title').textContent = data.live_status.window_title || '';
            document.getElementById('live-duration').textContent = formatTime(data.live_status.duration_seconds || 0);
            document.getElementById('current-activity').textContent = data.live_status.current_app;
            const stateEl = document.getElementById('current-state');
            stateEl.textContent = 'Active';
            stateEl.className = 'badge badge-state-active';
        } else {
            document.getElementById('live-status-banner').style.display = 'none';
            document.getElementById('current-activity').textContent = 'Offline';

            const stateEl = document.getElementById('current-state');
            if (stateEl) {
                stateEl.textContent = 'Offline';
                stateEl.className = 'badge badge-secondary';
            }
        }

        // Screen time - use actual database values
        const st = data.screen_time || {};
        const activeSeconds = st.active_seconds || 0;
        const idleSeconds = st.idle_seconds || 0;
        const lockedSeconds = st.locked_seconds || 0;
        const awaySeconds = st.away_seconds || 0;  // From database (prolonged locks >2h)

        const totalTracked = activeSeconds + idleSeconds + lockedSeconds + awaySeconds;

        document.getElementById('active-time').textContent = formatTime(activeSeconds);
        document.getElementById('idle-time').textContent = formatTime(idleSeconds);
        document.getElementById('locked-time').textContent = formatTime(lockedSeconds);
        document.getElementById('away-time').textContent = formatTime(awaySeconds);
        document.getElementById('total-time').textContent = formatTime(totalTracked);  // Total = Active + Idle + Locked + Away

        if (totalTracked > 0) {
            document.getElementById('active-pct').textContent = Math.round((activeSeconds / totalTracked) * 100) + '%';
            document.getElementById('idle-pct').textContent = Math.round((idleSeconds / totalTracked) * 100) + '%';
            document.getElementById('locked-pct').textContent = Math.round((lockedSeconds / totalTracked) * 100) + '%';
            document.getElementById('away-pct').textContent = Math.round((awaySeconds / totalTracked) * 100) + '%';
        } else {
            document.getElementById('active-pct').textContent = '0%';
            document.getElementById('idle-pct').textContent = '0%';
            document.getElementById('locked-pct').textContent = '0%';
            document.getElementById('away-pct').textContent = '0%';
        }

        // Render tables
        renderAppUsage(data.app_usage, data.live_status);
        renderDomainUsage(data.domain_usage, data.live_status);
        renderDomainVisits(data.domain_visits);
        renderInventory(data.inventory);
        loadScreenTimeHistory();

        // Update Quick Stats
        updateQuickStats(data);
    }

    function updateQuickStats(data) {
        // Screen time (active + idle)
        const st = data.screen_time || {};
        const totalScreenSeconds = (st.active_seconds || 0) + (st.idle_seconds || 0);
        document.getElementById('quick-screen-time').textContent = formatTime(totalScreenSeconds);

        // Apps used count
        document.getElementById('quick-apps-count').textContent = data.app_usage?.count || 0;

        // Domains visited count
        document.getElementById('quick-domains-count').textContent = data.domain_usage?.count || 0;

        // App sessions count
        document.getElementById('quick-sessions-count').textContent = data.app_sessions?.count || 0;
    }

    function renderAppUsage(appData, liveStatus) {
        const tbody = document.getElementById('apps-body');
        tbody.innerHTML = '';
        document.getElementById('apps-count').textContent = `${appData?.count || 0} apps`;

        if (liveStatus?.current_app) {
            document.getElementById('app-ongoing-section').style.display = 'block';
            document.getElementById('ongoing-app-name').textContent = liveStatus.current_app;
            document.getElementById('ongoing-app-duration').textContent = formatTime(liveStatus.duration_seconds || 0);
        } else {
            document.getElementById('app-ongoing-section').style.display = 'none';
        }

        if (!appData?.data?.length) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No data</td></tr>';
            return;
        }

        appData.data.forEach(app => {
            const pct = parseFloat(app.percentage) || 0;
            const barClass = pct >= 20 ? 'high' : pct >= 5 ? 'medium' : 'low';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${app.app}</td>
                <td class="text-right">${app.session_count || '-'}</td>
                <td class="text-right font-mono">${formatTime(app.duration_seconds)}</td>
                <td class="text-right">
                    <div class="usage-bar-container">
                        <div class="usage-bar"><div class="usage-bar-fill ${barClass}" style="width:${Math.min(pct, 100)}%"></div></div>
                        <span>${app.percentage}%</span>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderDomainUsage(domainData, liveStatus) {
        const tbody = document.getElementById('domains-body');
        tbody.innerHTML = '';
        document.getElementById('domains-count').textContent = `${domainData?.count || 0} domains`;

        if (liveStatus?.current_domain) {
            document.getElementById('domain-ongoing-section').style.display = 'block';
            document.getElementById('ongoing-domain-name').textContent = liveStatus.current_domain;
            document.getElementById('ongoing-domain-duration').textContent = formatTime(liveStatus.domain_duration || 0);
        } else {
            document.getElementById('domain-ongoing-section').style.display = 'none';
        }

        if (!domainData?.data?.length) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No data</td></tr>';
            return;
        }

        const total = domainData.data.reduce((sum, d) => sum + (d.duration_seconds || 0), 0);
        domainData.data.forEach(d => {
            const pct = total > 0 ? ((d.duration_seconds || 0) / total * 100).toFixed(1) : 0;
            const barClass = pct >= 20 ? 'high' : pct >= 5 ? 'medium' : 'low';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${d.domain}</td>
                <td class="text-right">${d.session_count || '-'}</td>
                <td class="text-right font-mono">${formatTime(d.duration_seconds)}</td>
                <td class="text-right">
                    <div class="usage-bar-container">
                        <div class="usage-bar"><div class="usage-bar-fill ${barClass}" style="width:${Math.min(pct, 100)}%"></div></div>
                        <span>${pct}%</span>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderDomainVisits(visitsData) {
        const list = document.getElementById('visits-list');
        list.innerHTML = '';
        document.getElementById('visits-count').textContent = `${visitsData?.count || 0} visits`;

        if (!visitsData?.data?.length) {
            list.innerHTML = '<div class="text-center text-muted p-4">No browser history</div>';
            return;
        }

        visitsData.data.slice(0, 100).forEach(v => {
            const div = document.createElement('div');
            div.className = 'site-item';
            div.innerHTML = `
                <span class="time">${v.visited_at ? formatBrowserHistoryTime(v.visited_at) : ''}</span>
                <span class="domain">${v.domain}</span>
                <span class="text-muted">${v.browser || ''}</span>
            `;
            list.appendChild(div);
        });
    }

    function renderInventory(invData) {
        const tbody = document.getElementById('inventory-body');
        tbody.innerHTML = '';
        document.getElementById('inventory-count').textContent = `${invData?.count || 0} apps`;

        if (!invData?.data?.length) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No inventory data</td></tr>';
            return;
        }

        invData.data.forEach(app => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight: 500;">${escapeHtml(app.name)}</td>
                <td style="font-size: 0.875rem; color: var(--text-secondary);">${escapeHtml(app.version || '-')}</td>
                <td style="font-size: 0.875rem;">${escapeHtml(cleanPublisher(app.publisher))}</td>
                <td class="font-mono text-xs tooltip-container" data-tooltip="${escapeHtml(app.install_location || '')}" style="color: var(--text-tertiary);">
                    ${escapeHtml(cleanInstallLocation(app.install_location))}
                </td>
                <td style="font-size: 0.875rem;">${formatInstallDate(app.install_date)}</td>
                <td>${getSourceBadge(app.source)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Clean publisher name from certificate strings
    function cleanPublisher(publisher) {
        if (!publisher || publisher === '-') return 'Unknown';

        // Extract clean name from certificate string
        // "CN=Microsoft Windows, O=Microsoft Corporation, L=Redmond, S=Washington, C=US"
        const cnMatch = publisher.match(/CN=([^,]+)/);
        const oMatch = publisher.match(/O=([^,]+)/);

        if (cnMatch && cnMatch[1]) {
            return cnMatch[1].trim();
        } else if (oMatch && oMatch[1]) {
            return oMatch[1].trim();
        }

        // If no certificate format, just truncate if too long
        return publisher.length > 40 ? publisher.substring(0, 37) + '...' : publisher;
    }

    // Clean install location for display
    function cleanInstallLocation(location) {
        if (!location || location === '-') return '-';

        // Show only key parts: drive + ...filename
        const parts = location.split('\\');
        if (parts.length > 4) {
            return `${parts[0]}\\...\\${parts[parts.length - 1]}`;
        }
        if (location.length > 40) {
            return '...' + location.slice(-37);
        }
        return location;
    }

    // Format install date nicely
    function formatInstallDate(dateStr) {
        if (!dateStr || dateStr === '-') return '-';
        try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        } catch {
            return dateStr;
        }
    }

    // XSS Protection: Escape HTML entities
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function getSourceBadge(source) {
        if (!source) return '<span class="badge badge-secondary">Unknown</span>';
        if (source.includes('HKLM')) return '<span class="badge badge-info">System</span>';
        if (source.includes('HKCU')) return '<span class="badge badge-warning">User</span>';
        if (source.includes('Store')) return '<span class="badge badge-primary">Store</span>';
        return `<span class="badge badge-secondary">${escapeHtml(source)}</span>`;
    }

    // Screen Time History Chart (7 days)
    async function loadScreenTimeHistory() {
        const data = await fetchJSON(`/dashboard/api/agent/${AGENT_ID}/screentime`);
        if (!data) return;

        const ctx = document.getElementById('screentime-history-chart');
        if (!ctx) return;

        if (window.screentimeChart) window.screentimeChart.destroy();

        window.screentimeChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    { label: 'Active', data: data.active, backgroundColor: '#38bdf8', stack: 'Stack 0', borderRadius: 4 },
                    { label: 'Idle', data: data.idle, backgroundColor: '#fbbf24', stack: 'Stack 0', borderRadius: 4 },
                    { label: 'Locked', data: data.locked, backgroundColor: '#64748b', stack: 'Stack 0', borderRadius: 4 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { callback: (val) => formatTimeShort(val) },
                        stacked: true,
                        title: { display: true, text: 'Usage Time' }
                    },
                    x: { stacked: true, grid: { display: false } }
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => ctx.dataset.label + ': ' + formatTime(ctx.parsed.y)
                        }
                    }
                }
            }
        });
    }

    function exportTableToCSV(tableId, filename) {
        const table = document.getElementById(tableId);
        let csv = [];
        table.querySelectorAll('tr').forEach(row => {
            let cols = [];
            row.querySelectorAll('th, td').forEach(col => cols.push('"' + col.textContent.trim().replace(/"/g, '""') + '"'));
            csv.push(cols.join(','));
        });
        const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
    }

    // ============================================================
    // Fix #13: Smart Auto-Refresh with Visibility Detection
    // ============================================================
    let autoRefreshInterval = null;
    let lastUpdateTime = new Date();
    const AUTO_REFRESH_INTERVAL = 10000; // 10 seconds

    // ============================================================
    // ENHANCED LIVE ACTIVITY DISPLAY
    // ============================================================
    const APP_ICONS = {
        'Brave': 'üõ°Ô∏è',
        'Chrome': 'üåê',
        'Firefox': 'ü¶ä',
        'Edge': 'üî∑',
        'Safari': 'üß≠',
        'Code': 'üíª',
        'Visual Studio': 'üíª',
        'Notepad': 'üìù',
        'Excel': 'üìä',
        'Word': 'üìÑ',
        'PowerPoint': 'üìΩÔ∏è',
        'Outlook': 'üìß',
        'Teams': 'üë•',
        'Slack': 'üí¨',
        'Discord': 'üéÆ',
        'Spotify': 'üéµ',
        'WhatsApp': 'üí¨',
        'Telegram': '‚úàÔ∏è',
        'Terminal': '‚¨õ',
        'PowerShell': '‚¨õ',
        'Explorer': 'üìÅ',
        'File Explorer': 'üìÅ'
    };

    function getAppIcon(appName) {
        if (!appName) return 'üñ•Ô∏è';
        for (const [key, emoji] of Object.entries(APP_ICONS)) {
            if (appName.toLowerCase().includes(key.toLowerCase())) {
                return emoji;
            }
        }
        return 'üñ•Ô∏è';
    }

    function formatDurationShort(seconds) {
        if (!seconds || seconds < 0) return '';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        if (mins > 60) {
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            return `${h}h ${m}m`;
        }
        if (mins > 0) {
            return `${mins}m ${secs}s`;
        }
        return `${secs}s`;
    }

    async function updateLiveActivity() {
        try {
            const data = await fetchJSON(`/dashboard/api/agent/${AGENT_ID}/current-activity`);

            const activityBadge = document.getElementById('current-activity');
            const liveBanner = document.getElementById('live-status-banner');
            const liveAppName = document.getElementById('live-app-name');
            const liveDuration = document.getElementById('live-duration');
            const liveWindowTitle = document.getElementById('live-window-title');
            const pulseDot = document.querySelector('.pulse');

            if (data && data.current_app) {
                const icon = getAppIcon(data.current_app);
                const duration = formatDurationShort(data.duration_seconds);

                // Update activity badge (header)
                if (activityBadge) {
                    activityBadge.innerHTML = `${icon} ${data.current_app}`;
                }

                // Update live status banner
                if (liveBanner) liveBanner.style.display = 'flex';
                if (liveAppName) liveAppName.textContent = data.current_app;
                if (liveDuration) liveDuration.textContent = duration;
                if (liveWindowTitle && data.window_title) {
                    liveWindowTitle.textContent = data.window_title;
                }

                // Update pulse dot color based on state
                if (pulseDot) {
                    const stateColors = {
                        'active': '#38bdf8',  // Sky Blue
                        'idle': '#fbbf24',    // Amber
                        'locked': '#64748b'   // Slate
                    };
                    pulseDot.style.background = stateColors[data.state] || '#38bdf8';
                    pulseDot.style.boxShadow = `0 0 8px ${stateColors[data.state] || '#38bdf8'}`;
                }

                // Update current state badge
                const stateEl = document.getElementById('current-state');
                if (stateEl) {
                    const stateLabels = { 'active': 'Active', 'idle': 'Idle', 'locked': 'Locked' };
                    const stateClasses = { 'active': 'badge-state-active', 'idle': 'badge-state-idle', 'locked': 'badge-state-locked' };
                    stateEl.textContent = stateLabels[data.state] || 'Active';
                    stateEl.className = `badge ${stateClasses[data.state] || 'badge-state-active'}`;
                }
            } else {
                // Offline or no activity
                if (activityBadge) {
                    activityBadge.innerHTML = '<span style="opacity: 0.7;">Offline</span>';
                }
                if (liveBanner) liveBanner.style.display = 'none';

                const stateEl = document.getElementById('current-state');
                if (stateEl) {
                    stateEl.textContent = 'Offline';
                    stateEl.className = 'badge badge-secondary';
                }
            }
        } catch (error) {
            console.error('Error updating live activity:', error);
        }
    }

    function startAutoRefresh() {
        if (autoRefreshInterval) return; // Already running

        autoRefreshInterval = setInterval(async () => {
            try {
                await loadFullReport();
                await updateLiveActivity();
                lastUpdateTime = new Date();
                console.log('[AutoRefresh] Data updated');
            } catch (error) {
                console.error('[AutoRefresh] Failed:', error);
            }
        }, AUTO_REFRESH_INTERVAL);

        console.log('[AutoRefresh] Started (10s interval)');
    }

    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            console.log('[AutoRefresh] Paused');
        }
    }

    // Pause refresh when tab is hidden to save resources
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            stopAutoRefresh();
        } else {
            // Immediate refresh when coming back
            loadFullReport();
            updateLiveActivity();
            startAutoRefresh();
        }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadFullReport();
        updateLiveActivity();
        startAutoRefresh();
    });

    const dateSelect = document.getElementById('global-date-select');
    if (dateSelect) dateSelect.addEventListener('change', loadFullReport);
</script>
{% endblock %}