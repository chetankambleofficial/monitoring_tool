{% extends "dashboard/base.html" %}

{% block title %}Reports - SentinelEdge Dashboard{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-8">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2">
           <img src="{{ url_for('static', filename='report.png') }}" class="w-6 h-6" />
            Generate Reports
        </h1>
        <p class="text-gray-600 dark:text-gray-400 mt-1">Export fleet-wide or individual agent activity data</p>
    </div>
</div>

<!-- Report Type Selection -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 cursor-pointer hover:shadow-md hover:border-blue-300 dark:hover:border-blue-600 transition-all duration-200 group" onclick="showSection('individual')">
        <div class="text-center">
            <div class="w-16 h-16 mx-auto bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center text-3xl mb-4 group-hover:bg-blue-200 dark:group-hover:bg-blue-800 transition-colors">
               <img src="{{ url_for('static', filename='user-setting.png') }}" class="w-8 h-8" />
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">Individual Agent</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Daily activity for a specific agent</p>
            <div class="flex justify-center gap-2">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">PDF</span>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">CSV</span>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 cursor-pointer hover:shadow-md hover:border-green-300 dark:hover:border-green-600 transition-all duration-200 group" onclick="showSection('fleet')">
        <div class="text-center">
            <div class="w-16 h-16 mx-auto bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center text-3xl mb-4 group-hover:bg-green-200 dark:group-hover:bg-green-800 transition-colors">
               <img src="{{ url_for('static', filename='users.png') }}" class="w-8 h-8" />
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">Fleet Summary</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Comparative fleet-wide statistics</p>
            <div class="flex justify-center">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">CSV Export</span>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 cursor-pointer hover:shadow-md hover:border-purple-300 dark:hover:border-purple-600 transition-all duration-200 group" onclick="showSection('inventory')">
        <div class="text-center">
            <div class="w-16 h-16 mx-auto bg-purple-100 dark:bg-purple-900 rounded-full flex items-center justify-center text-3xl mb-4 group-hover:bg-purple-200 dark:group-hover:bg-purple-800 transition-colors">
                 <img src="{{ url_for('static', filename='inventory.png') }}" class="w-8 h-8" />
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">App Inventory</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Full software inventory across fleet</p>
            <div class="flex justify-center">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200">CSV Export</span>
            </div>
        </div>
    </div>
</div>

<!-- Individual Agent Report Section -->
<div id="section-individual" class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6" style="display:none;">
    <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center text-xl">
           <img src="{{ url_for('static', filename='user-setting.png') }}" class="w-8 h-8" />
        </div>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Individual Agent Report</h2>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Agent</label>
            <select id="agent-select" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Loading agents...</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Report Date</label>
            <input type="date" id="report-date" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
    </div>
    
    <div class="flex flex-wrap gap-3">
        <button onclick="openAgentReport()" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            View Report (Print/PDF)
        </button>
        <button onclick="downloadAgentCSV()" class="inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Download CSV
        </button>
    </div>
</div>

<!-- Fleet Summary Section -->
<div id="section-fleet" class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6" style="display:none;">
    <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center text-xl">
      <img src="{{ url_for('static', filename='users.png') }}" class="w-8 h-8" />
        </div>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Fleet Summary Report</h2>
    </div>
    
    <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Report Date</label>
        <input type="date" id="fleet-date" class="w-full max-w-xs px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
    </div>
    
    <button onclick="downloadFleetCSV()" class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        Download Fleet Summary CSV
    </button>
</div>

<!-- Inventory Section -->
<div id="section-inventory" class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6" style="display:none;">
    <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center text-xl">
              <img src="{{ url_for('static', filename='inventory.png') }}" class="w-8 h-8" />
        </div>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Application Inventory Report</h2>
    </div>
    
    <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Agent (or All)</label>
        <select id="inventory-agent-select" class="w-full max-w-md px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <option value="all">All Agents (Combined)</option>
        </select>
    </div>
    
    <button onclick="downloadInventoryCSV()" class="inline-flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        Download Inventory CSV
    </button>
</div>

<!-- Quick Access Section -->
<div class="mb-6">
    <div class="flex items-center gap-3 mb-4">
        <svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
        </svg>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Quick Access - Agent Reports</h3>
    </div>
</div>

<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700">
        <p class="text-sm font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wide">Daily activity report shortcuts</p>
    </div>
    <div class="p-6">
        <div id="agents-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="text-center text-gray-500 dark:text-gray-400 py-8 col-span-full">Loading agents...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allAgents = [];

    document.addEventListener('DOMContentLoaded', async () => {
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('report-date').value = today;
        document.getElementById('fleet-date').value = today;

        // Load agents
        const response = await fetchJSON('/dashboard/api/agents');
        if (response && response.data) {
            allAgents = response.data;
            populateAgentSelects();
            renderAgentsGrid();
        }
    });

    function populateAgentSelects() {
        const agentSelect = document.getElementById('agent-select');
        const invSelect = document.getElementById('inventory-agent-select');

        agentSelect.innerHTML = '<option value="">-- Select Agent --</option>';

        allAgents.forEach(agent => {
            const option = document.createElement('option');
            option.value = agent.agent_id;
            option.textContent = `${agent.hostname || 'Unknown'} (${agent.agent_id.substring(0, 8)}...)`;
            agentSelect.appendChild(option);

            const option2 = option.cloneNode(true);
            invSelect.appendChild(option2);
        });
    }

    function renderAgentsGrid() {
        const grid = document.getElementById('agents-grid');
        grid.innerHTML = '';

        if (allAgents.length === 0) {
            grid.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 col-span-full">No agents registered</div>';
            return;
        }

        allAgents.forEach(agent => {
            const card = document.createElement('div');
            card.className = 'bg-gray-50 dark:bg-gray-700 rounded-lg p-4 flex items-center justify-between hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors';

            const statusClass = agent.is_online ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' : 'bg-gray-100 dark:bg-gray-600 text-gray-800 dark:text-gray-200';
            const statusText = agent.is_online ? 'Online' : 'Offline';

            card.innerHTML = `
                <div class="flex-1">
                    <div class="font-semibold text-gray-900 dark:text-gray-100 flex items-center gap-2">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        ${agent.hostname || 'Unknown'}
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                        ${agent.os || 'Unknown OS'} â€¢ 
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                            ${statusText}
                        </span>
                    </div>
                </div>
                <a href="/dashboard/agent/${agent.agent_id}/report" class="inline-flex items-center px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    View
                </a>
            `;
            grid.appendChild(card);
        });
    }

    function showSection(section) {
        // Hide all sections
        document.querySelectorAll('[id^="section-"]').forEach(el => el.style.display = 'none');
        
        // Show selected section
        document.getElementById(`section-${section}`).style.display = 'block';
    }

    function openAgentReport() {
        const agentId = document.getElementById('agent-select').value;
        const date = document.getElementById('report-date').value;

        if (!agentId) {
            alert('Please select an agent');
            return;
        }

        window.open(`/dashboard/agent/${agentId}/report?date=${date}`, '_blank');
    }

    async function downloadAgentCSV() {
        const agentId = document.getElementById('agent-select').value;
        const date = document.getElementById('report-date').value;

        if (!agentId) {
            alert('Please select an agent');
            return;
        }

        const data = await fetchJSON(`/dashboard/api/agent/${agentId}/full-report?date=${date}`);
        if (!data) return;

        let csv = generateAgentCSV(data);
        downloadCSV(csv, `agent_report_${data.agent?.hostname || agentId}_${date}.csv`);
    }

    async function downloadFleetCSV() {
        const date = document.getElementById('fleet-date').value;

        const data = await fetchJSON(`/dashboard/api/agents?date=${date}`);
        if (!data || !data.data) {
            alert('No data available');
            return;
        }

        let csv = 'FLEET SUMMARY REPORT\n';
        csv += `Date,${date}\n`;
        csv += `Generated,${getCurrentTimeIST()}\n\n`;
        csv += 'Hostname,Agent ID,OS,Status,Active (seconds),Idle (seconds),Locked (seconds),Top App,Domains Visited,Installed Apps\n';

        data.data.forEach(agent => {
            csv += `"${agent.hostname || 'Unknown'}","${agent.agent_id}","${agent.os || ''}","${agent.status}",`;
            csv += `${agent.active_seconds || 0},${agent.idle_seconds || 0},${agent.locked_seconds || 0},`;
            csv += `"${agent.top_app || ''}",${agent.domains_visited || 0},${agent.installed_apps || 0}\n`;
        });

        downloadCSV(csv, `fleet_summary_${date}.csv`);
    }

    async function downloadInventoryCSV() {
        const agentId = document.getElementById('inventory-agent-select').value;

        let data;
        if (agentId === 'all') {
            // Fetch all agents and their inventory
            let allInventory = [];
            for (const agent of allAgents) {
                const inv = await fetchJSON(`/dashboard/api/agent/${agent.agent_id}/inventory`);
                if (inv && inv.data) {
                    inv.data.forEach(app => {
                        app.agent_hostname = agent.hostname;
                        app.agent_id = agent.agent_id;
                    });
                    allInventory = allInventory.concat(inv.data);
                }
            }
            data = { data: allInventory };
        } else {
            data = await fetchJSON(`/dashboard/api/agent/${agentId}/inventory`);
        }

        if (!data || !data.data || data.data.length === 0) {
            alert('No inventory data available');
            return;
        }

        let csv = 'APPLICATION INVENTORY\n';
        csv += `Generated,${getCurrentTimeIST()}\n\n`;

        if (agentId === 'all') {
            csv += 'Hostname,Agent ID,Application,Version,Publisher,Source\n';
            data.data.forEach(app => {
                csv += `"${app.agent_hostname || ''}","${app.agent_id || ''}","${app.name}","${app.version || ''}","${app.publisher || ''}","${app.source || ''}"\n`;
            });
        } else {
            csv += 'Application,Version,Publisher,Source\n';
            data.data.forEach(app => {
                csv += `"${app.name}","${app.version || ''}","${app.publisher || ''}","${app.source || ''}"\n`;
            });
        }

        downloadCSV(csv, `inventory_${agentId === 'all' ? 'fleet' : agentId}.csv`);
    }

    function generateAgentCSV(data) {
        let csv = 'AGENT ACTIVITY REPORT\n';
        csv += `Date,${data.date}\n`;
        csv += `Agent ID,${data.agent?.agent_id || ''}\n`;
        csv += `Hostname,${data.agent?.hostname || ''}\n`;
        csv += `Username,${data.agent?.username || ''}\n`;
        csv += `OS,${data.agent?.os || ''}\n\n`;

        // Screen Time
        csv += 'SCREEN TIME\n';
        csv += 'Type,Seconds,Formatted\n';
        csv += `Active,${data.screen_time?.active_seconds || 0},"${formatTime(data.screen_time?.active_seconds || 0)}"\n`;
        csv += `Idle,${data.screen_time?.idle_seconds || 0},"${formatTime(data.screen_time?.idle_seconds || 0)}"\n`;
        csv += `Locked,${data.screen_time?.locked_seconds || 0},"${formatTime(data.screen_time?.locked_seconds || 0)}"\n`;
        csv += `Total,${data.screen_time?.total_seconds || 0},"${formatTime(data.screen_time?.total_seconds || 0)}"\n\n`;

        // App Usage
        csv += 'APPLICATION USAGE\n';
        csv += 'Application,Duration (seconds),Duration (formatted),Sessions,Percentage\n';
        if (data.app_usage?.data) {
            data.app_usage.data.forEach(a => {
                csv += `"${a.app}",${a.duration_seconds},"${formatTime(a.duration_seconds)}",${a.session_count},${a.percentage}%\n`;
            });
        }
        csv += '\n';

        // Domain Usage
        csv += 'DOMAIN USAGE\n';
        csv += 'Domain,Duration (seconds),Duration (formatted),Sessions\n';
        if (data.domain_usage?.data) {
            data.domain_usage.data.forEach(d => {
                csv += `"${d.domain}",${d.duration_seconds},"${formatTime(d.duration_seconds)}",${d.session_count}\n`;
            });
        }

        return csv;
    }

    function downloadCSV(content, filename) {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
{% endblock %}