{% extends "dashboard/base.html" %}

{% block title %}Registered Agents - SentinelEdge Dashboard{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-8">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100 flex items-center gap-2">üñ•Ô∏è Registered Agents</h1>
        <p class="text-gray-600 dark:text-gray-400 mt-1">Full list of registered systems and their current state</p>
    </div>
    <div class="flex items-center gap-4">
        <input type="text" id="agent-search" placeholder="Search hostname, user, or ID..." class="px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
        <select id="status-filter" class="px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
            <option value="all">All Agents</option>
            <option value="active">Active Now</option>
            <option value="idle">Idle</option>
            <option value="offline">Offline</option>
        </select>
    </div>
</div>

<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600" id="agents-table">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortTable(0)">Hostname & ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortTable(1)">User</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortTable(2)">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortTable(3)">Current Activity</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="sortTable(4)">Screen Time</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Top App</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Apps</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Domains</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Inventory</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Last Seen</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody id="agents-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-600">
                <tr>
                    <td colspan="11" class="px-6 py-12 text-center">
                        <div class="w-8 h-8 border-2 border-primary-200 border-t-primary-600 rounded-full animate-spin mx-auto mb-4"></div>
                        <p class="text-gray-500 dark:text-gray-400">Loading fleet data...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allAgents = [];

    async function loadAgents() {
        console.log('[AGENTS] Fetching agent list...');
        const response = await fetchJSON('/dashboard/api/agents');
        if (!response || !response.data) {
            console.error('[AGENTS] Failed to fetch agents or empty response');
            showToast('Failed to load agent data', 'danger');
            return;
        }

        allAgents = response.data;
        console.log(`[AGENTS] Successfully loaded ${allAgents.length} agents`);
        renderAgents();
    }

    function renderAgents() {
        const tbody = document.getElementById('agents-body');
        const searchTerm = document.getElementById('agent-search').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;

        // Filter Logic
        const filtered = allAgents.filter(agent => {
            const matchesSearch = (agent.hostname || '').toLowerCase().includes(searchTerm) ||
                (agent.agent_id || '').toLowerCase().includes(searchTerm) ||
                (agent.username || '').toLowerCase().includes(searchTerm);

            let matchesStatus = true;
            const isOnline = agent.is_online; // Use the server-provided status

            if (statusFilter === 'active') matchesStatus = isOnline;
            else if (statusFilter === 'offline') matchesStatus = !isOnline;

            return matchesSearch && matchesStatus;
        });

        tbody.innerHTML = '';

        if (filtered.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" class="px-6 py-12 text-center">
                        <div class="text-4xl mb-4">üîç</div>
                        <p class="text-lg font-semibold text-gray-600 dark:text-gray-300">No agents matching your criteria</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Try adjusting your search or filter</p>
                    </td>
                </tr>`;
            return;
        }

        filtered.forEach(agent => {
            const tr = document.createElement('tr');

            // Status Badge with telemetry stale warning
            let statusHtml;
            if (agent.telemetry_stale) {
                // Online but not sending data - SILENT FAILURE!
                statusHtml = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800" title="‚ö†Ô∏è Agent is online but not sending data!">‚ö†Ô∏è Stale</span>';
            } else if (agent.is_online) {
                statusHtml = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">üü¢ Online</span>';
            } else {
                statusHtml = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">üî¥ Offline</span>';
            }

            // Add operational status indicator
            if (agent.operational_status === 'DEGRADED') {
                statusHtml += '<br><small class="text-yellow-600">‚ö†Ô∏è Degraded</small>';
            }

            // Current activity with state icon
            let currentActivity = '<span class="text-gray-500">-</span>';
            if (agent.current_app) {
                const stateIcon = agent.current_state === 'active' ? 'üéØ' :
                    agent.current_state === 'idle' ? 'üí§' : 'üîí';
                currentActivity = `<span class="text-gray-900 dark:text-gray-100">${stateIcon} ${agent.current_app}</span>`;
            }

            // Relative time (IST)
            const lastSeenText = agent.last_seen
                ? getRelativeTimeIST(agent.last_seen)
                : 'Never';

            // Screen time with breakdown
            const screenTime = formatTime(agent.total_screen_seconds || 0);
            const screenTimeTitle = `Active: ${formatTime(agent.active_seconds || 0)}, Idle: ${formatTime(agent.idle_seconds || 0)}, Locked: ${formatTime(agent.locked_seconds || 0)}`;

            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <a href="/dashboard/agent/${agent.agent_id}" class="text-primary-600 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-300 font-medium">
                        <strong>${agent.hostname || 'Unknown'}</strong>
                    </a>
                    <br><small class="text-gray-500 dark:text-gray-400 font-mono text-xs">${agent.agent_id.slice(0, 12)}...</small>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${agent.username || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap">${statusHtml}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">${currentActivity}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
                    <span title="${screenTimeTitle}">${screenTime}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${agent.top_app || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${agent.total_apps_used || 0}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${agent.domains_visited || 0}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${agent.installed_apps || 0}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400"><span title="${agent.last_seen || ''}">${lastSeenText}</span></td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                    <a href="/dashboard/agent/${agent.agent_id}" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 transition-colors">
                        View
                    </a>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Event Listeners
    document.getElementById('agent-search').addEventListener('input', debounce(renderAgents, 300));
    document.getElementById('status-filter').addEventListener('change', renderAgents);

    // Initial Load
    document.addEventListener('DOMContentLoaded', loadAgents);

    // Auto-refresh every 60 seconds
    setInterval(loadAgents, 60000);
</script>
{% endblock %}